<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple GPS Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEp6G5ohue5zt4XPLT2O7Lrptq+0tfIJ3mkeVvTxj0x5/x/9edm4x/d1iCsoZJ3HG9Oc8S7Q==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-BwHfrr4c9kmRkLw6iqC0D3ZAjj6NSJnsar6hhnzbEOKFe1zqxisQwC4T3qGeiJ9sFT42zimbRNpN8G3x89rEA==" crossorigin=""></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Check if geolocation is supported
        if (navigator.geolocation) {
            let called = false;
            const timeoutId = setTimeout(() => {
                if (!called) {
                    error({ code: 3, message: "Manual timeout: Location request took too long." });
                }
            }, 12000); // Manual timeout slightly longer than native

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    called = true;
                    clearTimeout(timeoutId);
                    success(position);
                },
                (err) => {
                    called = true;
                    clearTimeout(timeoutId);
                    error(err);
                },
                { timeout: 10000, enableHighAccuracy: true } // Native timeout and high accuracy
            );
        } else {
            alert("Geolocation is not supported by this browser.");
        }

        // Success callback: Initialize map with user's location
        function success(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Create the map centered on the user's location (zoom level 13 for street view)
            const map = L.map('map').setView([lat, lon], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add a marker for the user's location
            L.marker([lat, lon]).addTo(map)
                .bindPopup('You are here')
                .openPopup();
        }

        // Error callback: Handle geolocation errors
        function error(err) {
            let message = "Unable to retrieve your location.";
            if (err.code === 1) {
                message = "Location access denied. Please enable location services for Safari/Chrome in your iOS settings (Settings > Privacy & Security > Location Services > Safari Websites) and try again.";
            } else if (err.code === 2) {
                message = "Location information is unavailable. Ensure location services are enabled.";
            } else if (err.code === 3) {
                message = "The request to get location timed out. This may happen if location services are disabled or taking too long. Check your iOS settings.";
            } else {
                message = "An unknown error occurred: " + err.message;
            }
            alert(message);
        }
    </script>
</body>
</html>