<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GPS ‚Äî Shared Location Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
    html, body { margin: 0; height: 100%; background:#0b0b0c; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    #app { height: 100%; display:grid; grid-template-rows:auto 1fr; }
    .status { position:sticky; top:0; z-index:1000; padding:calc(10px + var(--safe-top)) 12px 10px; background:rgba(15,15,17,.95); backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; gap:10px; }
    .status .info { font-size:13px; color:#b9b9b9; }
    .status .info b { color:#fff; }
    #map { height:100%; width:100%; }
    .fab { position: fixed; right: 12px; bottom: calc(12px + var(--safe-bottom)); z-index: 1001; display:grid; place-items:center; width:56px; height:56px; border-radius:16px; background:#111216; color:#fff; border:1px solid rgba(255,255,255,.1); box-shadow:0 8px 30px rgba(0,0,0,.35); font-size:24px; user-select:none; -webkit-tap-highlight-color:transparent; cursor:pointer; }
    .leaflet-container { background:#0b0b0c; }
    .hint { position: fixed; left: 12px; bottom: calc(80px + var(--safe-bottom)); z-index: 1001; font-size:12px; color:#b9b9b9; background:rgba(17,18,22,.9); padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08); max-width: 80vw; }
    .pill { padding:10px 12px; border-radius:12px; background:#1a1b20; color:#fff; border:1px solid rgba(255,255,255,.12); }
  </style>
</head>
<body>
  <div id="app">
    <div class="status">
      <div class="info" id="statusText">Waiting for GPS‚Ä¶</div>
      <div class="info" id="metaText">Peers ‚Äî ¬∑ Room ‚Äî</div>
    </div>
    <div id="map"></div>
    <!-- Controls -->
    <div id="controls" style="position:fixed;left:12px;bottom:calc(12px + var(--safe-bottom));z-index:1002;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button id="shareToggle" class="pill">‚è∏ Stop</button>
      <button id="settingsBtn" class="pill">‚öôÔ∏è</button>
      <button id="wakeBtn" class="pill">üîí Keep screen on</button>
    </div>

    <dialog id="settingsDlg" style="border:none;border-radius:16px;background:#121318;color:#fff;padding:16px;max-width:92vw;">
      <form method="dialog" style="display:grid;gap:10px;">
        <div style="font-weight:600">Settings</div>
        <label style="display:grid;gap:6px;font-size:13px;">
          <span>Name</span>
          <input id="nameInput" placeholder="Your name" class="pill" style="padding:10px;"/>
        </label>
        <label style="display:grid;gap:6px;font-size:13px;">
          <span>Color</span>
          <input type="color" id="colorInput" style="height:40px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#1a1b20;"/>
        </label>
        <label style="display:grid;gap:6px;font-size:13px;">
          <span>Room</span>
          <input id="roomInput" placeholder="global" class="pill" style="padding:10px;"/>
          <small style="color:#aaa">Changing room applies instantly (no refresh).</small>
        </label>
        <menu style="display:flex;gap:8px;justify-content:flex-end;margin:0;padding:0;">
          <button value="cancel" class="pill">Close</button>
          <button id="saveSettings" value="default" class="pill" style="background:#2a6fff;">Save</button>
        </menu>
      </form>
    </dialog>
  </div>
  <div class="fab" id="recenterBtn" title="Recenter">üìç</div>
  <div class="hint">Tip: If peers show 0/0, add <code>?peer=https://relay.peer.ooo/gun</code> to the URL, or open on HTTPS/localhost.</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script>
    // ---------- Map ----------
    const map = L.map('map', { zoomControl:true }).setView([0,0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);

    const userIcon = L.icon({
      iconUrl: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36"><circle cx="18" cy="18" r="8" fill="#4f8cff"/><circle cx="18" cy="18" r="4" fill="white"/></svg>`),
      iconSize: [36,36], iconAnchor:[18,18]
    });
    let myMarker = L.marker([0,0], { icon:userIcon }).addTo(map);
    let accuracyCircle = L.circle([0,0], { radius:0, color:'#4f8cff', fillColor:'#4f8cff', fillOpacity:.08, weight:1 }).addTo(map);

    // ---------- UI refs ----------
    const statusText = document.getElementById('statusText');
    const metaText = document.getElementById('metaText');
    const recenterBtn = document.getElementById('recenterBtn');
    const shareToggle = document.getElementById('shareToggle');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsDlg = document.getElementById('settingsDlg');
    const nameInput = document.getElementById('nameInput');
    const colorInput = document.getElementById('colorInput');
    const roomInput = document.getElementById('roomInput');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const wakeBtn = document.getElementById('wakeBtn');

    // ---------- App state ----------
    let firstFix = true; let lastPos = null; let watchId = null; let pollTimer = null; let wakeLock = null;

    // ---------- GUN setup (with live room switching) ----------
    const DEFAULT_PEERS = ['https://relay.peer.ooo/gun','https://gun-manhattan.herokuapp.com/gun'];
    function getPeers(){
      try{
        const qp = new URLSearchParams(location.search);
        const urlPeer = qp.get('peer');
        const stored = JSON.parse(localStorage.getItem('gunPeers')||'[]');
        return [...new Set([...(urlPeer? [urlPeer]:[]), ...stored, ...DEFAULT_PEERS])];
      }catch(e){ return DEFAULT_PEERS.slice(); }
    }
    const gun = Gun({ peers: getPeers(), retry: 2000, file: false });

    function roomKey(){ return 'gps/v3/' + (new URLSearchParams(location.search).get('room') || localStorage.getItem('gps_room') || 'global'); }
    let currentRoom = roomKey();
    let presence = gun.get(currentRoom);

    const myId = localStorage.getItem('gps_id') || (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2));
    localStorage.setItem('gps_id', myId);
    function displayName(){ return localStorage.getItem('gps_name') || 'User'; }
    function myColor(){ return localStorage.getItem('gps_color') || '#22d3ee'; }

    const others = new Map();
    function upsertOther(id, data){
      if (!data || id === myId) return;
      const { lat, lng, ts, name, color: clr } = data || {};
      if (typeof lat !== 'number' || typeof lng !== 'number') return;
      let m = others.get(id);
      const ic = L.divIcon({ className:'', html:`<div style="display:grid;place-items:center;">
        <div style="width:14px;height:14px;border-radius:50%;background:${clr||'#22d3ee'};box-shadow:0 0 0 3px rgba(34,211,238,.25);"></div>
        <div style="margin-top:4px;font-size:11px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6);max-width:120px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${(name||'User')}</div>
      </div>` });
      if (!m){ m = L.marker([lat,lng], { icon: ic, interactive:false }).addTo(map); others.set(id, m); }
      else { m.setLatLng([lat,lng]); m.setIcon(ic); }
      m._lastSeen = ts || Date.now();
    }

    function subscribeRoom(){
      presence.map().on((data, id) => upsertOther(id, data));
      metaText.textContent = `Peers 0/0 ¬∑ Room ${currentRoom.split('/').pop()}`;
    }
    subscribeRoom();

    function switchRoom(newRoom){
      if (newRoom === currentRoom) return;
      // Unsubscribe old
      presence.off();
      // Clear others' markers
      for (const [, m] of others){ map.removeLayer(m); }
      others.clear();
      // Switch
      currentRoom = newRoom; presence = gun.get(currentRoom); subscribeRoom();
      // Broadcast immediately in new room
      if (lastPos) broadcast(lastPos.coords.latitude, lastPos.coords.longitude);
    }

    function broadcast(lat, lng){
      presence.get(myId).put({ lat, lng, ts: Gun.state(), name: displayName(), color: myColor() });
    }

    // ---------- Location: hybrid updater (watch + poll) ----------
    function onPosition(pos){
      lastPos = pos;
      const { latitude, longitude, accuracy } = pos.coords;
      const latlng = [latitude, longitude];
      myMarker.setLatLng(latlng);
      accuracyCircle.setLatLng(latlng).setRadius(accuracy || 0);
      if (firstFix) { map.setView(latlng, 17); firstFix = false; }
      statusText.innerHTML = `<b>GPS Fix:</b> ${latitude.toFixed(6)}, ${longitude.toFixed(6)} ¬∑ ¬±${Math.round(accuracy||0)}m`;
      broadcast(latitude, longitude);
    }
    function onError(err){
      const msgs = { 1: 'Permission denied', 2: 'Position unavailable', 3: 'Timeout' };
      statusText.innerHTML = `<b>GPS Error:</b> ${msgs[err.code] || err.message}`;
    }

    function startWatch(){
      if (!('geolocation' in navigator)) return;
      if (watchId !== null) navigator.geolocation.clearWatch(watchId);
      watchId = navigator.geolocation.watchPosition(onPosition, onError, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
      // Fallback poll: refresh a reading every 20s in case watch stalls (iOS quirk)
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(() => {
        navigator.geolocation.getCurrentPosition(onPosition, ()=>{}, { enableHighAccuracy:true, maximumAge:0, timeout:5000 });
      }, 20000);
    }
    function stopWatch(){
      if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }

    // Start immediately (autoshare on)
    shareToggle.dataset.state = 'on';
    startWatch();

    recenterBtn.addEventListener('click', () => { if (lastPos) map.setView([lastPos.coords.latitude, lastPos.coords.longitude], 17); });

    // Live controls
    shareToggle.addEventListener('click', () => {
      const sharing = shareToggle.dataset.state !== 'on';
      if (sharing){
        shareToggle.dataset.state = 'on'; shareToggle.textContent = '‚è∏ Stop';
        startWatch();
        if (lastPos) broadcast(lastPos.coords.latitude, lastPos.coords.longitude);
      } else {
        shareToggle.dataset.state = 'off'; shareToggle.textContent = '‚ñ∂ Share';
        stopWatch();
        try { presence.get(myId).put(null); } catch(e){}
      }
    });

    settingsBtn.addEventListener('click', () => {
      nameInput.value = localStorage.getItem('gps_name') || displayName() || '';
      colorInput.value = (localStorage.getItem('gps_color') || myColor());
      roomInput.value = (new URLSearchParams(location.search).get('room') || localStorage.getItem('gps_room') || 'global');
      settingsDlg.showModal();
    });

    saveSettingsBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (nameInput.value) { localStorage.setItem('gps_name', nameInput.value); }
      if (colorInput.value) { localStorage.setItem('gps_color', colorInput.value); }
      const newRoomName = roomInput.value || 'global';
      localStorage.setItem('gps_room', newRoomName);
      switchRoom('gps/v3/' + newRoomName);
      settingsDlg.close();
    });

    // Keep updating when tab becomes active again; rebind watch for iOS
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && shareToggle.dataset.state === 'on') {
        startWatch();
        if (lastPos) broadcast(lastPos.coords.latitude, lastPos.coords.longitude);
      }
    });

    // Network changes: re-open peers and rebroadcast
    window.addEventListener('online', () => { if (shareToggle.dataset.state === 'on' && lastPos) broadcast(lastPos.coords.latitude, lastPos.coords.longitude); });

    // Optional: Wake Lock to keep screen on (prevents iOS pausing timers)
    async function requestWake(){
      try{ wakeLock = await navigator.wakeLock.request('screen'); wakeBtn.textContent = '‚úÖ Screen stays on';
        wakeLock.addEventListener('release', ()=>{ wakeBtn.textContent = 'üîí Keep screen on'; });
      }catch(e){ wakeBtn.textContent = '‚ö†Ô∏è Wake lock unavailable'; }
    }
    wakeBtn.addEventListener('click', ()=>{ if (wakeLock) { wakeLock.release(); wakeLock = null; } else { requestWake(); } });

    // Presence maintenance & cleanup
    setInterval(() => { if (!lastPos || shareToggle.dataset.state !== 'on') return; broadcast(lastPos.coords.latitude, lastPos.coords.longitude); }, 15000);
    setInterval(() => { const now = Date.now(); for (const [id, m] of others) { if (now - (m._lastSeen || 0) > 60000) { map.removeLayer(m); others.delete(id); } } }, 10000);

    // Peer status UI
    function setPeerStatus(){
      const dict = gun.back('opt.peers') || {};
      const list = Object.keys(dict);
      let up = 0; list.forEach(u => { const p = dict[u]; if (p && p.wire && !p.wire.hied) up++; });
      metaText.textContent = `Peers ${up}/${list.length} ¬∑ Room ${currentRoom.split('/').pop()}`;
    }
    setInterval(setPeerStatus, 2000); setPeerStatus();
  </script>
</body>
</html>